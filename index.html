<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panoramic Viewer</title>

    <!-- Leaflet and Plugins -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: black;
            font-family: 'Monument Grotesk', sans-serif;
        }

        #panorama {
            height: 100%;
            width: 100%;
            background-color: black;
        }

        .leaflet-container {
            background-color: black;
        }

        .top-text, .bottom-text {
            position: absolute;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            max-height: 40%;
            overflow-y: auto;
            opacity: 0; /* Initially invisible */
            transition: opacity 1.5s ease-in-out;
        }


        .fade-in {
            opacity: 1 !important; /* Make text visible */
        }

        #landscape-message {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-align: center;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
        }

        @media (max-width: 600px) {
            .top-text, .bottom-text {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<div id="panorama"></div>
<div class="top-text" id="topText">
    Non-Linear Assembly...
</div>
<div class="bottom-text" id="bottomText">
    التجمع غير الخطي...
</div>
<div id="landscape-message">Portrait mode only</div>

<script>
    var TILE_SIZE = 256;
    var MAX_ZOOM = 12;
    var TILES_X = 2891;
    var TILES_Y = 4;
    var FADE_DISTANCE = 5 * TILE_SIZE;
    var isPanning = false;
    var panSpeed = 0;
    var cursorX = window.innerWidth / 2;
    var panInterval;
    var deadZone = 0.1; // 10% dead zone in the middle
    var baseSpeed = 100; // Base speed multiplier for the panning
    var speedZones = 25;  // Number of speed zones for smooth transitions

    var map = L.map('panorama', {
        minZoom: 2,
        maxZoom: MAX_ZOOM,
        zoom: 2,
        crs: L.CRS.Simple,
        doubleClickZoom: false,
        attributionControl: false,
        zoomControl: false,
        doubleTapDragZoom: 'center',
        doubleTapDragZoomOptions: {
            reverse: false
        }
    });

    function setInitialView() {
        var bounds = new L.LatLngBounds(
            map.unproject([0, TILE_SIZE * TILES_Y], MAX_ZOOM),
            map.unproject([TILE_SIZE * TILES_X, 0], MAX_ZOOM)
        );
        map.setMaxBounds(bounds);
        var centerLatLng = map.unproject([(TILE_SIZE * TILES_X) / 2, (TILE_SIZE * TILES_Y) / 2], MAX_ZOOM);
        map.setView(centerLatLng, 2);
    }

    setInitialView();

    L.tileLayer('https://chipper-sunflower-e51e1a.netlify.app/tiles/tile_z{z}_x{x}_y{y}.jpg', {
        maxZoom: MAX_ZOOM,
        noWrap: true,
        crossOrigin: true
    }).addTo(map);

    var audioInitialized = false;
    var initialClickHandled = false;

    function adjustVolume() {
        var centerLng = map.getCenter().lng * TILE_SIZE;
        var zoomLevel = map.getZoom();
        var maxVolume = (zoomLevel - 2) / (MAX_ZOOM - 2);
    }

    map.on('move', adjustVolume);

    map.on('click', function(e) {
        if (!initialClickHandled) {
            initialClickHandled = true;
            
            document.getElementById('topText').classList.add('fade-in');
            document.getElementById('bottomText').classList.add('fade-in');

            if (!audioInitialized) {
                audioInitialized = true;
            }

            var clickedLatLng = e.latlng;
            var centerLng = Math.max(0, Math.min(TILE_SIZE * TILES_X, map.project(clickedLatLng, MAX_ZOOM).x));
            var centerLatLng = map.unproject([centerLng, (TILE_SIZE * TILES_Y) / 2], MAX_ZOOM);
            var zoomLevel = MAX_ZOOM - 1;

            if (/Mobi|Android/i.test(navigator.userAgent)) {
                zoomLevel += 1; 
            }

            map.flyTo(centerLatLng, zoomLevel, {
                animate: true,
                duration: 4
            });

            map.once('moveend', function() {
                adjustVolume();
                isPanning = true;
                startPanLoop();
            });
        }
    });

    // Function to calculate pan speed and direction with smooth transitions
    function calculatePanSpeed() {
        var screenWidth = window.innerWidth;
        var screenCenter = screenWidth / 2;
        var distanceFromCenter = cursorX - screenCenter;

        // Dead zone in the middle
        var deadZoneSize = screenWidth * deadZone;
        if (Math.abs(distanceFromCenter) < deadZoneSize / 2) {
            return 0; // No panning in the dead zone
        }

        // Normalize distance and calculate speed using multiple zones for smooth transition
        var zoneWidth = (screenWidth - deadZoneSize) / (2 * speedZones); // Width of each speed zone
        var panFactor = 0;

        for (var i = 1; i <= speedZones; i++) {
            var zoneStart = (i - 1) * zoneWidth + deadZoneSize / 2;
            var zoneEnd = i * zoneWidth + deadZoneSize / 2;

            if (Math.abs(distanceFromCenter) >= zoneStart && Math.abs(distanceFromCenter) < zoneEnd) {
                panFactor = i / speedZones;
                break;
            }
        }

        panFactor *= baseSpeed * Math.sign(distanceFromCenter);  // Pan speed is proportional to the distance from the center

        return panFactor;  // Smooth speed between zones
    }

    // Function to start continuous panning based on cursor position
    function startPanLoop() {
        if (panInterval) clearInterval(panInterval);

        panInterval = setInterval(function() {
            if (isPanning) {
                var panSpeed = calculatePanSpeed();
                map.panBy([panSpeed, 0], { animate: false });
            }
        }, 1);  // Short interval for ultra-smooth panning
    }

    // Update cursor position on mouse move
    document.addEventListener('mousemove', function(e) {
        cursorX = e.clientX;
    });

    // Adjust for iOS or orientation changes
    function checkOrientation() {
        var isMobile = /Mobi|Android/i.test(navigator.userAgent);
        if (isMobile && window.innerHeight < window.innerWidth) {
            document.getElementById('landscape-message').style.display = 'block';
            document.getElementById('panorama').style.display = 'none';
            document.getElementById('topText').style.display = 'none';
            document.getElementById('bottomText').style.display = 'none';
        } else {
            document.getElementById('landscape-message').style.display = 'none';
            document.getElementById('panorama').style.display = 'block';
            if (!initialClickHandled) {
                document.getElementById('topText').style.display = 'block';
                document.getElementById('bottomText').style.display = 'block';
            }
        }
    }

    window.addEventListener('resize', checkOrientation);
    checkOrientation();
</script>

</body>
</html>
