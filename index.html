<!DOCTYPE html>
<html>
<head>
    <title>Panoramic Viewer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Monument+Grotesk:wght@300;400;500;600;700;800;900&display=swap');
        
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Monument Grotesk', sans-serif;
        }
        #panorama {
            height: 100vh;
            width: 100vw;
            background-color: black;
        }
        .leaflet-container {
            background-color: black;
        }
        .top-text {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            text-align: left;
            width: 80%;
            z-index: 1000;
            font-size: 16px;
            display: block;
        }
        .bottom-text {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            text-align: right;
            width: 80%;
            z-index: 1000;
            font-size: 16px;
            direction: rtl;
        }
        .start-text-english, .start-text-arabic {
            position: absolute;
            color: white;
            width: 100%;
            text-align: center;
            z-index: 1000;
            font-size: 18px;
        }
        .start-text-english {
            top: calc(48.75% - 40px); /* Adjusted to 48.75% with -40px offset */
        }
        .start-text-arabic {
            top: calc(48.75% + 40px); /* Adjusted to 48.75% with 40px offset */
            direction: rtl;
        }
        .fade-out {
            animation: fadeOut 1.5s forwards;
        }
        .fade-in {
            animation: fadeIn 1.5s forwards;
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                display: none;
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
                display: block;
            }
        }
        @media (max-height: 800px) {
            .top-text, .bottom-text {
                font-size: 12px;
            }
            .start-text-english, .start-text-arabic {
                font-size: 14px;
            }
        }
        @media (max-height: 600px) {
            .top-text, .bottom-text {
                font-size: 10px;
            }
            .start-text-english, .start-text-arabic {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<div class="top-text" id="topText">
    Non-Linear Assembly<br><br>
    In response to the October 7th attacks by Hamas, the Israeli Defence Forces have responded by inflicting an unimaginable amount of pain and destruction on Gaza, killing at least 37,000 Palestinians, including over 15,000 children. While the International court of justice has concluded that the Israeli government has committed crimes including starvation of civilians as a weapon of war, murder, extermination, and intentional attacks on civilians, many western countries including the United Kingdom have supported this war on Palestinian people.<br><br>
    In response, Londoners have participated in a long series of large pro-Palestinian support marches in a continuous effort since the first national demonstration on October 14, 2023. Despite the media and government narratives vilifying these marches as marginal, troublesome, and hateful in order to continue their unchallenged support of the Israeli government, these marches are a broad cross-section of society unified in peaceful protest. They serve as a testament to the widespread impact of the Gaza conflict on global consciousness.<br><br>
    This project is a linear rendering of the pro-Palestinian march that took place in London on January 13th, 2024 and an ode to the people that call for compassion, humanity, and peace.
</div>

<div class="start-text-english" id="startTextEnglish">
    Click/tap anywhere on the line below to start
</div>

<div class="start-text-arabic" id="startTextArabic">
    انقر على السطر للبدء
</div>

<div class="bottom-text" id="bottomText">
    التجمع غير الخطي<br><br>
    ردًا على هجمات حماس في السابع من تشرين الأول/أكتوبر، ردت قوات الدفاع الإسرائيلية بإلحاق قدر لا يمكن تصوره من الألم والدمار بغزة، مما أسفر عن مقتل ما لا يقل عن سبعة وثلاثين ألف فلسطيني، بما في ذلك أكثر من خمسة عشر طفلاً. وبينما خلصت محكمة العدل الدولية إلى أن الحكومة الإسرائيلية ارتكبت جرائم بما في ذلك تجويع المدنيين كسلاح في الحرب، والقتل والإبادة، والهجمات المتعمدة على المدنيين، فقد دعمت العديد من الدول الغربية، بما في ذلك المملكة المتحدة، هذه الحرب على الشعب الفلسطيني.<br><br>
    ردًا على ذلك، شارك سكان لندن في سلسلة طويلة من مسيرات الدعم الكبيرة المؤيدة للفلسطينيين في جهد متواصل منذ المظاهرة الوطنية الأولى في الرابع عشر من أكتوبر عام ألفين وثلاثة وعشرين. على الرغم من الروايات الإعلامية والحكومية التي تشوه هذه المسيرات باعتبارها هامشية ومزعجة وبغيضة من أجل مواصلة دعمها بلا منازع للحكومة الإسرائيلية، فإن هذه المسيرات تمثل شريحة واسعة من المجتمع متحدة في الاحتجاج السلمي. وهي بمثابة شهادة على التأثير الواسع النطاق للصراع في غزة على الوعي العالمي.<br><br>
    هذا المشروع عبارة عن عرض مكتوب للمسيرة المؤيدة للفلسطينيين التي جرت في لندن في الثالث عشر من يناير عام ألفين وأربعة وعشرين، وقصيدة للشعب الذي يدعو إلى الرحمة والإنسانية والسلام.
</div>

<div id="panorama"></div>

<script>
    var TILE_SIZE = 256;
    var MAX_ZOOM = 12;
    var TILES_X = 2891;
    var TILES_Y = 4;
    var FADE_DISTANCE = 5 * TILE_SIZE;

    var map = L.map('panorama', {
        minZoom: 2,
        maxZoom: MAX_ZOOM,
        zoom: 2,
        crs: L.CRS.Simple,
        doubleClickZoom: false,
        attributionControl: false,
        zoomControl: false,
        inertia: true,
        inertiaDeceleration: 2000,
        inertiaMaxSpeed: 1000,
        inertiaThreshold: 10
    });

    function setInitialView() {
        var bounds = new L.LatLngBounds(
            map.unproject([0, TILE_SIZE * TILES_Y], MAX_ZOOM),
            map.unproject([TILE_SIZE * TILES_X, 0], MAX_ZOOM)
        );
        map.setMaxBounds(bounds);
        var centerLatLng = map.unproject([(TILE_SIZE * TILES_X) / 2, (TILE_SIZE * TILES_Y) / 2], MAX_ZOOM);
        map.setView(centerLatLng, 2);
    }

    setInitialView();

    L.tileLayer('https://chipper-sunflower-e51e1a.netlify.app/tiles/tile_z{z}_x{x}_y{y}.jpg', {
        maxZoom: MAX_ZOOM,
        noWrap: true,
    }).addTo(map);

    var audioFiles = [
        'https://chipper-sunflower-e51e1a.netlify.app/audio/1.mp3',
        'https://chipper-sunflower-e51e1a.netlify.app/audio/2.mp3',
        'https://chipper-sunflower-e51e1a.netlify.app/audio/3.mp3',
        'https://chipper-sunflower-e51e1a.netlify.app/audio/4.mp3'
    ];

    var audioZones = [
        { start: 177, end: 190, audio: new Audio(audioFiles[0]) },
        { start: 170, end: 176, audio: new Audio(audioFiles[2]) },
        { start: 137, end: 169, audio: new Audio(audioFiles[1]) },
        { start: 58, end: 136, audio: new Audio(audioFiles[3]) },
        { start: 100, end: 120, audio: new Audio(audioFiles[1]) },
        { start: 100, end: 110, audio: new Audio(audioFiles[2]) },
        { start: 80, end: 90, audio: new Audio(audioFiles[1]) },
        { start: 50, end: 57, audio: new Audio(audioFiles[2]) },
        { start: 19, end: 56, audio: new Audio(audioFiles[3]) },
        { start: 8, end: 18, audio: new Audio(audioFiles[2]) },
        { start: 6, end: 7, audio: new Audio(audioFiles[1]) },
        { start: -10, end: 5, audio: new Audio(audioFiles[0]) }
    ];

    audioZones.forEach(function(zone) {
        zone.audio.loop = true;
        zone.audio.volume = 0;
        zone.audio.load();
        console.log(`Loaded audio file for zone: ${zone.audio.src}`);
    });

    var audioInitialized = false;
    var clickHandled = false;
    var initialClickHandled = false;

    function adjustVolume() {
        var centerLng = map.getCenter().lng * TILE_SIZE;
        var zoomLevel = map.getZoom();
        var maxVolume = (zoomLevel - 2) / (MAX_ZOOM - 2);

        audioZones.forEach(function(zone) {
            var volume = 0;
            if (centerLng >= (zone.start - FADE_DISTANCE) * TILE_SIZE && centerLng <= (zone.end + FADE_DISTANCE) * TILE_SIZE) {
                if (centerLng >= zone.start * TILE_SIZE && centerLng <= zone.end * TILE_SIZE) {
                    volume = maxVolume;
                } else if (centerLng < zone.start * TILE_SIZE) {
                    volume = maxVolume * (1 - ((zone.start * TILE_SIZE - centerLng) / FADE_DISTANCE));
                } else if (centerLng > zone.end * TILE_SIZE) {
                    volume = maxVolume * (1 - ((centerLng - zone.end * TILE_SIZE) / FADE_DISTANCE));
                }
            }

            zone.audio.volume = Math.max(0, volume);
            console.log(`Zone audio src: ${zone.audio.src}, volume: ${volume}`);
        });
    }

    function handleZoomEnd() {
        if (map.getZoom() <= map.getMinZoom() + 2) {
            document.getElementById('topText').classList.remove('fade-out');
            document.getElementById('topText').classList.add('fade-in');
            document.getElementById('bottomText').classList.remove('fade-out');
            document.getElementById('bottomText').classList.add('fade-in');
            clickHandled = false;
        } else {
            document.getElementById('topText').classList.remove('fade-in');
            document.getElementById('topText').classList.add('fade-out');
            document.getElementById('bottomText').classList.remove('fade-in');
            document.getElementById('bottomText').classList.add('fade-out');
        }
    }

    map.on('move', adjustVolume); // Adjust volume continuously as the map moves

    map.on('click', function(e) {
        if (!initialClickHandled) {
            initialClickHandled = true;
            document.getElementById('topText').classList.add('fade-out'); // Trigger fade out for top text
            document.getElementById('bottomText').classList.add('fade-out'); // Trigger fade out for bottom text
            document.getElementById('startTextEnglish').classList.add('fade-out'); // Trigger fade out for English start text
            document.getElementById('startTextArabic').classList.add('fade-out'); // Trigger fade out for Arabic start text

            if (!audioInitialized) {
                audioZones.forEach(function(zone) {
                    zone.audio.play().catch(error => {
                        console.error("Audio playback failed:", error);
                    });
                });
                audioInitialized = true;
            }

            var clickedLatLng = e.latlng;
            var centerLng = Math.max(0, Math.min(TILE_SIZE * TILES_X, map.project(clickedLatLng, MAX_ZOOM).x));
            var centerLatLng = map.unproject([centerLng, (TILE_SIZE * TILES_Y) / 2], MAX_ZOOM);
            var zoomLevel = MAX_ZOOM - 1;

            // Check if the device is mobile
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                zoomLevel -= 1; // Zoom one level less on mobile
            }

            map.flyTo(centerLatLng, zoomLevel, {
                animate: true,
                duration: 4
            });

            map.once('moveend', function() {
                clickHandled = true; // Prevent further interactions
                adjustVolume(); // Ensure volume is adjusted after moving
            });
        }
    });

    // Update volume continuously during the zoom
    map.on('zoomstart', adjustVolume);
    map.on('zoomend', adjustVolume);
    map.on('zoomend', handleZoomEnd); // Handle zoom end to make text reappear

    window.addEventListener('resize', function() {
        var currentCenter = map.getCenter();
        var currentZoom = map.getZoom();
        map.setView(currentCenter, currentZoom);
    });

    window.addEventListener('resizeend', function() {
        map.setView(currentCenter, currentZoom);
    });

    // Debounce the resize event to trigger resizeend event
    (function() {
        var resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                window.dispatchEvent(new Event('resizeend'));
            }, 250);
        });
    })();
</script>

</body>
</html>
